# Excel/CSV数据合并工具 - 完整使用指南

## 🎯 项目概述

这是一个强大的Python脚本集合，用于合并多个文件夹内的Excel(.xlsx)和CSV(.csv)数据表。支持递归搜索、自动编码检测、错误处理等高级功能。

## 📁 文件说明

### 核心脚本文件

| 文件名 | 功能描述 | 适用场景 |
|--------|----------|----------|
| `data_merger.py` | 完整功能的数据合并脚本 | 需要交互式配置和详细控制 |
| `quick_merge.py` | 简化配置的快速合并脚本 | 快速合并，配置简单 |
| `create_test_data.py` | 测试数据生成脚本 | 演示和测试功能 |

### 配置和文档文件

| 文件名 | 说明 |
|--------|------|
| `requirements.txt` | Python依赖包列表 |
| `DATA_MERGER_README.md` | 详细技术文档 |
| `使用指南.md` | 本使用指南文件 |

## 🚀 快速开始

### 1. 环境准备

```bash
# 安装必要依赖
pip install pandas openpyxl

# 或使用requirements文件
pip install -r requirements.txt
```

### 2. 使用简化版本（推荐新手）

```bash
# 1. 编辑 quick_merge.py 中的配置
# 2. 直接运行
python3 quick_merge.py
```

### 3. 使用完整版本（推荐高级用户）

```bash
python3 data_merger.py
```

## ⚙️ 配置说明

### quick_merge.py 配置示例

```python
# 输入文件夹路径
INPUT_FOLDERS = [
    "/Users/your_name/Documents/data1",    # 第一个数据文件夹
    "/Users/your_name/Documents/data2",    # 第二个数据文件夹
    "./local_data",                        # 相对路径示例
]

# 输出文件
OUTPUT_FILE = "合并数据_2024.xlsx"

# 自动运行（跳过确认）
AUTO_RUN = True
```

## 🧪 测试演示

### 创建测试数据

```bash
python3 create_test_data.py
```

这将创建以下测试文件结构：

```
test_data/
├── folder1/
│   ├── 销售数据.csv
│   └── 库存数据.xlsx
└── folder2/
    ├── 员工数据.csv
    └── 财务数据.xlsx
```

### 运行测试合并

脚本已预配置使用测试数据，直接运行：

```bash
python3 quick_merge.py
```

## 📊 输出结果

合并后的数据表包含：

- **原始数据**: 所有源文件的数据列
- **文件来源**: 显示数据来自哪个文件
- **文件夹路径**: 显示文件所在文件夹

### 示例输出文件结构

| 原始列1 | 原始列2 | ... | 文件来源 | 文件夹路径 |
|---------|---------|-----|----------|------------|
| 数据1   | 数据2   | ... | 销售数据.csv | ./test_data/folder1 |
| 数据3   | 数据4   | ... | 库存数据.xlsx | ./test_data/folder1 |

## 🔧 高级功能

### 1. 支持的文件格式

- **Excel**: `.xlsx` 格式
- **CSV**: `.csv` 格式，自动检测编码（UTF-8、GBK、Latin-1）

### 2. 错误处理

- 自动跳过不存在的文件夹
- 处理损坏或无法读取的文件
- 详细的错误报告

### 3. 大文件处理

- 逐个读取文件，节约内存
- 支持递归搜索子文件夹
- 进度显示和处理统计

## 📋 常见使用场景

### 场景1: 合并销售数据

```python
INPUT_FOLDERS = [
    "./2024年Q1销售数据",
    "./2024年Q2销售数据", 
    "./2024年Q3销售数据",
]
OUTPUT_FILE = "2024年销售数据汇总.xlsx"
```

### 场景2: 合并不同部门数据

```python
INPUT_FOLDERS = [
    "./财务部数据",
    "./销售部数据",
    "./技术部数据",
]
OUTPUT_FILE = "公司全部门数据.xlsx"
```

### 场景3: 合并多年历史数据

```python
INPUT_FOLDERS = [
    "./2022年数据",
    "./2023年数据", 
    "./2024年数据",
]
OUTPUT_FILE = "历史数据汇总_2022-2024.xlsx"
```

## ⚠️ 注意事项

1. **数据结构**: 确保要合并的文件具有相似的数据结构
2. **列名处理**: 不同文件的列名可能不同，pandas会自动处理缺失列
3. **内存使用**: 大量数据文件可能需要较长处理时间和更多内存
4. **磁盘空间**: 确保有足够的磁盘空间保存合并后的文件
5. **文件权限**: 确保对输入文件夹有读取权限，对输出位置有写入权限

## 🔍 故障排除

### 问题1: ModuleNotFoundError

**解决方案**:
```bash
pip install pandas openpyxl
```

### 问题2: 找不到文件夹

**解决方案**:
- 使用绝对路径
- 确认文件夹路径正确
- 检查文件夹权限

### 问题3: 编码错误

**解决方案**:
- 脚本已自动处理常见编码
- 手动转换CSV文件编码为UTF-8

### 问题4: 内存不足

**解决方案**:
- 分批处理大文件
- 关闭其他程序释放内存
- 考虑使用更强大的硬件

## 📈 性能优化

### 对于大量文件

1. **分批处理**: 将大量文件分成多个批次
2. **筛选文件**: 只处理需要的文件类型
3. **清理数据**: 在合并前清理无用列

### 对于大文件

1. **分块读取**: 对超大CSV文件使用chunksize参数
2. **数据类型优化**: 指定合适的数据类型减少内存使用
3. **压缩输出**: 使用压缩格式保存结果

## 🛠️ 自定义扩展

### 添加新文件格式支持

```python
# 在SUPPORTED_FORMATS中添加新格式
SUPPORTED_FORMATS = ['.xlsx', '.csv', '.xls', '.tsv']

# 在读取函数中添加处理逻辑
elif file_ext == '.xls':
    df = pd.read_excel(file_path, engine='xlrd')
elif file_ext == '.tsv':
    df = pd.read_csv(file_path, sep='\t')
```

### 添加数据清洗功能

```python
# 在读取文件后添加清洗步骤
df = df.dropna()  # 删除空行
df = df.drop_duplicates()  # 删除重复行
```

## 📞 获取帮助

如果遇到问题，请检查：

1. **Python版本**: 建议使用Python 3.7+
2. **依赖包版本**: 确保pandas和openpyxl版本兼容
3. **文件路径**: 使用绝对路径避免路径问题
4. **权限设置**: 确保有足够的文件读写权限

---

**祝您使用愉快！** 🎉 